<!doctype html>
<html lang="it">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Inserisci libro (form-only)</title>
	<style>
		label { display:block; margin-top:0.5rem }
		input { width: 100%; padding: 6px; box-sizing: border-box }
		select { display:block; margin-top:0.5rem }
	</style>
</head>
<body>
	<h1>Inserisci nuovo libro</h1>
	<p class="small">Questa pagina salva i libri nel file books.json</p>
	<form id="bookForm">
		<label>Titolo
			<input id="titolo" name="titolo" required>
		</label>
		<label>Autore
			<input id="autore" name="autore" required>
		</label>
		<label>Casa Editrice
			<input id="casaEditrice" name="casaEditrice">
		</label>
		<select name="genere" id="genere">
				<option value="narrativa">Narrativa</option>
				<option value="fantasy">Libro di Fantasy</option>
				<option value="giallo">Giallo</option>
		</select>
		<input type="file" id="fileInput" name="fileInput" accept=".json,application/json">
		<div class="actions">
			<button type="submit">Aggiungi</button>
		</div>
	</form>

	<div id="msg" class="msg" aria-live="polite"></div>

	<script>
		const STORAGE_KEY = 'biblioteca_singlefile_v1'; // rimane definito ma non usato per salvataggio
		let fileHandle = null;

		const qs = sel => document.querySelector(sel);
		const showMsg = t => qs('#msg').textContent = t;

		async function readBooksFromHandle(handle) {
			try { const f = await handle.getFile(); const txt = await f.text(); return txt ? JSON.parse(txt) : []; } catch { return []; }
		}
		async function writeToHandle(handle, books) {
			try {
				const w = await handle.createWritable();
				await w.write(JSON.stringify(books, null, 2));
				await w.close();
				return true;
			} catch (e) { console.warn(e); return false; }
		}
		async function pickHandle() {
			try {
				if (window.showSaveFilePicker) {
					return await window.showSaveFilePicker({
						suggestedName: 'books.json',
						types: [{ description: 'JSON', accept: { 'application/json': ['.json'] } }]
					});
				}
				if (window.showOpenFilePicker) {
					const [h] = await window.showOpenFilePicker({
						types: [{ description: 'JSON', accept: { 'application/json': ['.json'] } }],
						multiple: false
					});
					return h;
				}
			} catch (e) { /* user cancelled or not available */ }
			return null;
		}

		function nextIdFor(books) {
			return 1 + books.reduce((mx, b) => Math.max(mx, Number(b.id || 0)), 0);
		}

		async function appendBook(book) {
				// Try existing handle
				if (fileHandle) {
					const books = await readBooksFromHandle(fileHandle);
					book.id = String(nextIdFor(books));
					books.push(book);
					if (await writeToHandle(fileHandle, books)) {
						showMsg('Aggiunto e salvato in file (handle sessione).');
						return;
					}
					fileHandle = null; // reset and fall back to prompting again
				}
	
				// If FS API available, prompt to choose/create file and save directly
				if ('showSaveFilePicker' in window || 'showOpenFilePicker' in window) {
					showMsg('Seleziona o crea il file books.json per salvarlo automaticamente.');
					const h = await pickHandle();
					if (h) {
						fileHandle = h;
						const books = await readBooksFromHandle(fileHandle);
						book.id = String(nextIdFor(books));
						books.push(book);
						if (await writeToHandle(fileHandle, books)) {
							showMsg('Aggiunto e salvato in file (scelto).');
							return;
						}
						showMsg('Impossibile salvare sul file selezionato. Operazione annullata.');
					} else {
						showMsg('Nessun file selezionato. Operazione annullata.');
					}
					return;
				}
	
				// Fallback: if the user selected a file using the <input type="file">, read it and trigger a download with updated content
				const fileInput = qs('#fileInput');
				if (fileInput && fileInput.files && fileInput.files.length > 0) {
					try {
						const f = fileInput.files[0];
						const txt = await f.text();
						const books = txt ? JSON.parse(txt) : [];
						book.id = String(nextIdFor(books));
						books.push(book);
						const blob = new Blob([JSON.stringify(books, null, 2)], { type: 'application/json' });
						const url = URL.createObjectURL(blob);
						const a = document.createElement('a');
						a.href = url;
						a.download = 'books.json';
						document.body.appendChild(a);
						a.click();
						a.remove();
						URL.revokeObjectURL(url);
						showMsg('Aggiunto e scaricato books.json (download).');
						return;
					} catch (e) {
						console.warn(e);
						showMsg('Errore nel file selezionato. Operazione annullata.');
						return;
					}
				}
	
				// No File System Access API available and no file selected via input
				showMsg('API File System non disponibile. Impossibile salvare nel file.');
			}

		qs('#bookForm').addEventListener('submit', async ev => {
			ev.preventDefault();
			const titolo = qs('#titolo').value.trim();
			const autore = qs('#autore').value.trim();
			const casaEditrice = qs('#casaEditrice').value.trim();
			const genere = qs('select[name="genere"]').value;

			if (!titolo || !autore) { showMsg('Titolo e autore richiesti.'); return; }
			showMsg('Salvo...');
			await appendBook({ titolo, autore, casaEditrice, genere });
			ev.target.reset();
		});
	</script>
</body>
</html>
